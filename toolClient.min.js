function Fetch(){class e extends Promise{static withResolvers(){let e,t;return{promise:new this(((r,s)=>{e=r,t=s})),resolve:e,reject:t}}toJson(e=(e=>e)){return this.then((({body:t})=>e(JSON.parse(t))))}toStr(e=(e=>e)){return this.then((({body:t})=>e("string"==typeof t?t:JSON.stringify(t,null,2))))}toBinaryString(e){return e.reduce(((e,t)=>e+String.fromCharCode(t)),"")}toBase64Image(e){return this.then((({body:t,bodyBytes:r,headers:s})=>{const n=e?`data:${s["Content-Type"]};base64,`:"",o=r?this.toBinaryString(new Uint8Array(r)):this.toBinaryString(t);return n+btoa(o)}))}}class t{static setResponse(e){return this.#e=e.bind(this),this}static#t={Default(e,t){$.http[e.method.toLocaleLowerCase()](e).then((e=>t(e)))}};static#e=({error:e,body:t,bodyBytes:r,status:s,headers:n})=>{if(e||s<200||s>399)throw new Error(e??t);return{bodyBytes:r,body:t,status:s,headers:n}};constructor(e){return new Proxy(((...e)=>this.#r(this.#s("get",...e))),{get:(e,t)=>(...e)=>this.#r(this.#s(t,...e))})}#r(r){const{promise:s,resolve:n}=e.withResolvers(),o=r.timeout*($.isSurge()?1:1e3);t.#t.Default({...r,timeout:o},n);const i=setTimeout((()=>n({error:"请求超时"})),1e3*r.timeout);return s.then(t.#e).catch((async e=>{if(r.maxRetries<=1)throw e;return await new Promise((e=>setTimeout(e,1e3*r.retryDelay))),r.maxRetries--,this.#r(r)})).finally((()=>clearTimeout(i)))}#s(e,t,r=0,s=1){"string"==typeof t&&(t={url:t});const{$auto:n=!0,...o}=t;return{method:e,headers:this.#n(t.headers),timeout:4,maxRetries:r,retryDelay:s,...o}}#n(e={}){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e.toLowerCase(),t])))}}return new t}
